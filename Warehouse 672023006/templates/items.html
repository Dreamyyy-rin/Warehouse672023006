<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Items</title>
  <script src="https://cdn.webix.com/edge/webix.js"></script>
  <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<script>
async function setupMenuVisibility() {
    try {
        const response = await fetch("/api/user/info");
        const userInfo = await response.json();
        
        // Update user info display
        const userInfoElement = document.getElementById("user-info");
        if (userInfoElement) {
            userInfoElement.innerText = 
                `${userInfo.username} (${userInfo.role.charAt(0).toUpperCase() + userInfo.role.slice(1)})`;
        }

        // Menu permissions
        const menuPermissions = {
            'admin': ['dashboard', 'items', 'transactions', 'suppliers', 'categories', 'destinations', 'users'],
            'manager': ['dashboard', 'items', 'transactions', 'suppliers', 'categories', 'destinations'],
            'staff': ['dashboard', 'transactions']
        };

        const allowedMenus = menuPermissions[userInfo.role.toLowerCase()] || [];

        // Hide unauthorized menus
        document.querySelectorAll('.sidebar a').forEach(link => {
            const href = link.getAttribute('href');
            const menuName = href.replace('/', '');
            if (!allowedMenus.includes(menuName)) {
                link.style.display = 'none';
            }
        });
    } catch (err) {
        console.error("Failed to load user info:", err);
        // Only redirect if truly unauthorized
        if (err.status === 401) {
            window.location.href = '/login';
        }
    }
}

// Call when DOM loaded
document.addEventListener('DOMContentLoaded', setupMenuVisibility);
</script>

<div style="display:flex; height:100vh;">
  <div class="sidebar">
    <h2>ğŸ“¦ Warehouse</h2>
    <a href="/dashboard" id="menu-dashboard">ğŸ  Dashboard</a>
    <a href="/items" id="menu-items" class="active">ğŸ“‹ Items</a>
    <a href="/transactions" id="menu-transactions">ğŸ’° Transactions</a>
    <a href="/suppliers" id="menu-suppliers">ğŸ¢ Suppliers</a>
    <a href="/categories" id="menu-categories">ğŸ—‚ï¸ Categories</a>
    <a href="/destinations" id="menu-destinations">ğŸ“¦ Destinations</a>
    <a href="/users" id="menu-users">ğŸ‘¥ Users</a>
    <div style="margin-top:auto; padding:20px;">
      <form action="/logout" method="post">
        <button type="submit">Logout</button>
      </form>
    </div>
  </div>

  <div style="flex:1; display:flex; flex-direction:column;">
    <div class="topbar">
      <div><b>Items Management</b></div>
      <div id="user-info">Guest (-)</div>
    </div>

    <div style="padding:10px; background:#f8f9fa; display:flex; gap:10px;">
      <button class="webix_button" id="addItemBtn">â• Add Item</button>
      <button class="webix_button" id="editItemBtn">âœï¸ Edit Item</button>
      <button class="webix_button" id="deleteItemBtn">ğŸ—‘ï¸ Delete Item</button>
      <button class="webix_button" id="viewHistoryBtn">ğŸ“œ View History</button>
    </div>

    <div id="itemsTable" style="flex:1;"></div>
  </div>
</div>

<script>
// helper function
function formatIDR(value) {
  return "Rp " + Number(value).toLocaleString("id-ID");
}

// Add to all templates
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// ===== Datatable =====
let itemsTable = webix.ui({
  container: "itemsTable", 
  view: "datatable",
  columns: [
    { id: "name", header: ["Name", {content:"textFilter"}], fillspace: 2, sort: "string",
      template: (obj) => escapeHtml(obj.name) },
    { id: "stock", header: ["Stock", {content:"numberFilter"}], width: 90, sort: "int" },
    { id: "price", header: ["Price", {content:"numberFilter"}], width: 120,
      template: obj => formatIDR(obj.price || 0) },
    { id: "category_name", header: ["Category", {content:"selectFilter"}], width: 150 },
    { id: "supplier_name", header: ["Supplier", {content:"selectFilter"}], width: 150 },
    { 
      id: "is_active", 
      header: ["Status", {
        content: "selectFilter",
        options: [
            {id: "1", value: "Active"},
            {id: "0", value: "Inactive"}
        ]
      }],
      width: 110,
      template: function(obj) {
        return obj.is_active === 1 || obj.is_active === true || obj.is_active === "1" ? "âœ… Active" : "âŒ Inactive";
      }
    }
  ],
  select: true,
  height: 500,
  scroll: true,
  url: "/api/items"
});

// ===== Modal Add/Edit Item =====
let itemFormWin = webix.ui({
  view:"window",
  id:"itemFormWin",
  width:400,
  position:"center",
  modal:true,
  head:"Item Form",
  body: {
    view: "form",
    id: "itemForm",
    elements: [
      { view:"text", name:"name", label:"Name", required:true },
      { view:"text", name:"price", label:"Price", required:true, validate:webix.rules.isNumber },
      {
        view: "combo", // Change from richselect to combo
        label: "Category",
        name: "category_id",
        options: {
          body: {
            template: "#value#",
            url: "/api/categories/active"
          },
          filter: function(item, value) {
            return item.value.toString().toLowerCase().indexOf(value.toLowerCase()) !== -1;
          }
        }
      },
      {
        view: "combo", // Change from richselect to combo
        label: "Supplier",
        name: "supplier_id",
        options: {
          body: {
            template: "#value#",
            url: "/api/suppliers/active"
          },
          filter: function(item, value) {
            return item.value.toString().toLowerCase().indexOf(value.toLowerCase()) !== -1;
          }
        }
      },
      { margin:5, cols:[
        { view:"button", value:"Save", css:"webix_primary", click:saveItem },
        { view:"button", value:"Cancel", click:function(){ itemFormWin.hide(); } }
      ]}
    ],
    rules:{
      name:webix.rules.isNotEmpty,
      price:webix.rules.isNumber
    }
  }
});

// ===== Save Form =====
function saveItem(){
  let form = $$("itemForm");
  if(!form.validate()) return;

  let values = form.getValues();
  let url = values._id ? `/items/edit/${values._id}` : "/items/add";

  fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(values)
  }).then(r=>r.json()).then(d=>{
    webix.message(d.message);
    itemFormWin.hide();
    itemsTable.clearAll();
    itemsTable.load("/api/items");
  });
}

// ===== Buttons =====
document.getElementById("addItemBtn").addEventListener("click", ()=>{
  $$("itemForm").clear();
  itemFormWin.getHead().setHTML("Add Item");
  itemFormWin.show();
});

document.getElementById("editItemBtn").addEventListener("click", ()=>{
  let sel = itemsTable.getSelectedItem();
  if(!sel){
    webix.message({type:"error", text:"Select item to edit"});
    return;
  }
  $$("itemForm").setValues(sel);
  itemFormWin.getHead().setHTML("Edit Item");
  itemFormWin.show();
});

document.getElementById("deleteItemBtn").addEventListener("click", ()=>{
  let sel = itemsTable.getSelectedItem();
  if(!sel){
    webix.message({type:"error", text:"Select item!"});
    return;
  }

  webix.confirm(`Nonaktifkan item "${sel.name}"?`).then(()=>{
    fetch(`/items/deactivate/${sel._id}`,{method:"POST"})
    .then(r=>r.json()).then(d=>{
      webix.message(d.message);
      itemsTable.clearAll();
      itemsTable.load("/api/items");
    });
  });
});

// Add to templates/items.html
let searchForm = {
    view: "form",
    elements: [
        {
            cols: [
                {
                    view: "text",
                    id: "searchField",
                    placeholder: "Search items...",
                    on: {
                        onTimedKeyPress: function() {
                            let value = this.getValue().toLowerCase();
                            itemsTable.filter(function(obj) {
                                return obj.name.toLowerCase().indexOf(value) !== -1 ||
                                       obj.category_name.toLowerCase().indexOf(value) !== -1 ||
                                       obj.supplier_name.toLowerCase().indexOf(value) !== -1;
                            });
                        }
                    }
                },
                {
                    view: "button",
                    value: "Clear",
                    width: 100,
                    click: function() {
                        $$("searchField").setValue("");
                        itemsTable.filter("");
                    }
                }
            ]
        }
    ]
};

// Add export buttons toolbar first
let historyToolbar = {
  view: "toolbar",
  elements: [
    { 
      view: "button", 
      value: "Excel",
      width: 120,
      click: function() {
        webix.toExcel($$("stockHistoryTable"), {
          filename: "stock_history",
          name: "History",
          columns: {
            timestamp: {header: "Date"},
            type: {header: "Type"}, 
            quantity: {header: "Quantity"},
            details_name: {header: "Details"}
          }
        });
      }
    },
    { 
      view: "button",
      value: "PDF",
      width: 120, 
      click: function() {
        webix.toPDF($$("stockHistoryTable"), {
          filename: "stock_history",
          orientation: "portrait",
          autowidth: true,
          columns: {
            timestamp: {header: "Date", width: 100},
            type: {header: "Type", width: 80},
            quantity: {header: "Quantity", width: 80}, 
            details_name: {header: "Details", width: 200}
          }
        });
      }
    }
  ]
};

// Then create window with toolbar
let stockHistoryWin = webix.ui({
  view: "window",
  id: "stockHistoryWin",
  width: 800,
  height: 600,
  position: "center",
  modal: true,
  head: {
    cols: [
      { view: "label", id: "historyTitle", label: "Stock History" },
      { 
        view: "button",
        value: "Excel",
        width: 100,
        click: function() {
          if(!$$("stockHistoryTable").count()) return;
          webix.toExcel($$("stockHistoryTable"), {
            filename: "stock_history",
            name: "Stock History",
            columns: {
              timestamp: {header: "Date", width: 100},
              type: {header: "Type", width: 80},
              quantity: {header: "Quantity", width: 80},
              details_name: {header: "Details", width: 200}
            }
          });
        }
      },
      { 
        view: "button",
        value: "PDF",
        width: 100,
        click: function() {
          if(!$$("stockHistoryTable").count()) return;
          webix.toPDF($$("stockHistoryTable"), {
            filename: "stock_history",
            orientation: "portrait",
            autowidth: true,
            columns: {
              timestamp: {header: "Date", width: 100},
              type: {header: "Type", width: 80},
              quantity: {header: "Quantity", width: 80},
              details_name: {header: "Details", width: 200}
            }
          });
        }
      },
      { 
        view: "button",
        type: "icon",
        icon: "wxi-close",
        width: 50,
        Heigh: 50,
        click: function() {
          $$("stockHistoryWin").hide();
        }
      }
    ]
  },
  body: {
    rows: [
      {
        view: "datatable",
        id: "stockHistoryTable",
        columns: [
          { id: "timestamp", header: "Date", width: 150, sort: "string" },
          { id: "type", header: "Type", width: 100, sort: "string" },
          { id: "quantity", header: "Quantity", width: 100, sort: "int" },
          { id: "details_name", header: "Details", fillspace: true, sort: "string" }
        ],
        select: true,
        scroll: true,
        autoheight: false
      }
    ]
  }
});

// Update view history button handler
document.getElementById("viewHistoryBtn").addEventListener("click", function() {
  let sel = itemsTable.getSelectedItem();
  if(!sel) {
    webix.message({type: "error", text: "Please select an item first"});
    return;
  }

  fetch(`/api/items/${sel._id}/history`)
    .then(r => r.json())
    .then(data => {
      $$("historyTitle").setValue(`Stock History: ${sel.name}`);
      $$("stockHistoryTable").clearAll();
      $$("stockHistoryTable").parse(data);
      $$("stockHistoryWin").show();
    })
    .catch(err => {
      console.error("Error loading history:", err);
      webix.message({type: "error", text: "Failed to load history"});
    });
});
</script>

</body>
</html>

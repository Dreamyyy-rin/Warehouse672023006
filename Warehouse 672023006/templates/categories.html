<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Categories</title>
  <script src="https://cdn.webix.com/edge/webix.js"></script>
  <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<script>
async function setupMenuVisibility() {
    try {
        const response = await fetch("/api/user/info");
        const userInfo = await response.json();
        
        // Update user info display
        const userInfoElement = document.getElementById("user-info");
        if (userInfoElement) {
            userInfoElement.innerText = 
                `${userInfo.username} (${userInfo.role.charAt(0).toUpperCase() + userInfo.role.slice(1)})`;
        }

        // Menu permissions
        const menuPermissions = {
            'admin': ['dashboard', 'items', 'transactions', 'suppliers', 'categories', 'destinations', 'users'],
            'manager': ['dashboard', 'items', 'transactions', 'suppliers', 'categories', 'destinations'],
            'staff': ['dashboard', 'transactions']
        };

        const allowedMenus = menuPermissions[userInfo.role.toLowerCase()] || [];

        // Hide unauthorized menus
        document.querySelectorAll('.sidebar a').forEach(link => {
            const href = link.getAttribute('href');
            const menuName = href.replace('/', '');
            if (!allowedMenus.includes(menuName)) {
                link.style.display = 'none';
            }
        });
    } catch (err) {
        console.error("Failed to load user info:", err);
        // Only redirect if truly unauthorized
        if (err.status === 401) {
            window.location.href = '/login';
        }
    }
}

// Call when DOM loaded
document.addEventListener('DOMContentLoaded', setupMenuVisibility);
</script>

<div style="display:flex; height:100vh;">
  <div class="sidebar">
    <h2>ğŸ“¦ Warehouse</h2>
    <a href="/dashboard" id="menu-dashboard">ğŸ  Dashboard</a>
    <a href="/items" id="menu-items">ğŸ“‹ Items</a>
    <a href="/transactions" id="menu-transactions">ğŸ’° Transactions</a>
    <a href="/suppliers" id="menu-suppliers">ğŸ¢ Suppliers</a>
    <a href="/categories" id="menu-categories" class="active">ğŸ—‚ï¸ Categories</a>
    <a href="/destinations" id="menu-destinations">ğŸ“¦ Destinations</a>
    <a href="/users" id="menu-users">ğŸ‘¥ Users</a>
    <div style="margin-top:auto; padding:20px;">
      <form action="/logout" method="post">
        <button type="submit">Logout</button>
      </form>
    </div>
  </div>

  <div style="flex:1; display:flex; flex-direction:column;">
    <div class="topbar">
      <div><b>Categories</b></div>
      <div id="user-info">Guest (-)</div>
    </div>

    <div style="padding:10px; background:#f8f9fa;">
      <button class="webix_button" id="addCategoryBtn">â• Add Category</button>
    </div>

    <div id="categoriesTable" style="flex:1;"></div>
  </div>
</div>

<script>
// Helper Functions
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Use in templates
template: (obj) => escapeHtml(obj.name)

fetch("/api/user/info").then(r=>r.json()).then(d=>{
  document.getElementById("user-info").innerText = `${d.username} (${d.role})`;
});

// ===== Categories Table =====
let categoriesTable = webix.ui({
  container:"categoriesTable",
  view:"datatable",
  url:"/api/categories",
  columns:[
    { id:"name", header:["Name", { content:"textFilter" }], fillspace:2, sort:"string", template: obj => escapeHtml(obj.name) },
    { id:"description", header:["Description", { content:"textFilter" }], fillspace:3, sort:"string", template: obj => escapeHtml(obj.description) },
    { id:"is_active", header:["Status", {
        content: "selectFilter",
        options: [
            {id: "1", value: "Active"},
            {id: "0", value: "Inactive"}
        ]
      }],
      width: 110,
      sort: "int",
      template: function(obj) {
        return Number(obj.is_active) === 1 ? "âœ… Active" : "âŒ Inactive";
      }
    },
    { id:"action", header:"Action", width:150, template:function(obj){
        return `<span class='edit-btn'>Edit</span> <span class='delete-btn'>Delete</span>`;
    }}
  ],
  select:"row",
  scrollX:true,
  autoheight:false,
  autowidth:false
});

// ===== Refresh function =====
function refreshCategories(){
  webix.ajax().get("/api/categories", function(text, data){
    let cats = data.json();
    categoriesTable.clearAll();
    categoriesTable.parse(cats);
  });
}

// ===== Category Form Modal =====
let categoryFormWin = webix.ui({
  view:"window",
  id:"categoryFormWin",
  width:400,
  position:"center",
  modal:true,
  head:"Category Form",
  body:{
    view:"form",
    id:"categoryForm",
    elements:[
      { view:"text", label:"Name", name:"name", required:true },
      { view:"textarea", label:"Description", name:"description" },
      {
        margin:5, cols:[
          { view:"button", value:"Save", css:"webix_primary", click:function(){
              let form = $$("categoryForm");
              if(form.validate()){
                let values = form.getValues();
                let id = form.config.categoryId;
                if(id){ // Edit
                  fetch(`/api/categories/${id}`, {
                    method:"PUT",
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(values)
                  }).then(r=>r.json()).then(d=>{
                    webix.message(d.message);
                    $$("categoryFormWin").hide();
                    refreshCategories();
                  });
                } else { // Add
                  values.is_active = true;
                  fetch("/api/categories", {
                    method:"POST",
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(values)
                  }).then(r=>r.json()).then(d=>{
                    webix.message(d.message);
                    $$("categoryFormWin").hide();
                    refreshCategories();
                  });
                }
              }
          }},
          { view:"button", value:"Cancel", click:function(){ $$("categoryFormWin").hide(); } }
        ]
      }
    ],
    rules:{ name:webix.rules.isNotEmpty }
  }
});

// ===== Event Buttons =====
document.getElementById("addCategoryBtn").addEventListener("click", ()=>{
  $$("categoryForm").clear();
  $$("categoryForm").config.categoryId = null;
  $$("categoryFormWin").show();
});

// ===== Table Action Buttons =====
categoriesTable.attachEvent("onItemClick", function(id, e, node){
  let item = this.getItem(id.row);

  if(e.target.classList.contains("edit-btn")){
    $$("categoryForm").setValues(item);
    $$("categoryForm").config.categoryId = item._id;
    $$("categoryFormWin").show();

  } else if(e.target.classList.contains("delete-btn")){
    webix.confirm({
      title:"Confirm Delete",
      ok:"Yes", cancel:"No",
      text:`Delete category ${item.name}?`,
      callback:function(res){
        if(res){
          fetch(`/api/categories/${item._id}`, { method:"DELETE" })
          .then(r=>r.json()).then(d=>{
            webix.message(d.message);
            refreshCategories();
          });
        }
      }
    });
  }
});

// ===== Initial load =====
refreshCategories();
</script>
</body>
</html>
